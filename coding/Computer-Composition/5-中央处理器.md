<!-- omit in toc -->
# 中央处理器 CPU

## 1. CPU 的组成

CPU：由运算器和控制器组成

- CPU 的功能：执行指令、操作控制（生成操作信号）、时间控制（生成时间控制信号）、中断处理
- CPU 执行指令的流程：取指令、译码、执行指令（数据运算、写入存储器）

运算器：数据加工

- 算术逻辑单元 (ALU)：进行各种操作运算
- 通用寄存器组：存储 CPU 用于计算的数据
- 暂存寄存器：临时存储数据总线上的数据，避免输入或者输出的数据对总线的占用
- 累加寄存器 (ACC)：临时存储 ALU 计算的中间结果
- 程序状态字寄存器 (PSW)、移位器、计数器：辅助计算乘除法、运算状态等

控制器的基本组成：

- 程序计数器 (PC)：存储一下条指令在内存中存放的地址，带有自增功能
- 指令寄存器 (IR)：临时存储具体的指令，用于译码和执行
- 指令译码器：根据指令的操作码进行指令译码，向控制器提供操作信号
- 存储器地址寄存器 (MAR)：存放访问的内存单元的地址
- 存储器数据寄存器 (MDR)：存储向内存写入的数据或从内存读出的数据
- 时序系统：产生时序信号，由时钟信号分频得到
- 微操作信号发生器：根据译码的内容，产生对应的控制信号

用户可见的寄存器：通用寄存器组、程序状态字、程序计数器、累加器

- 用户不可见的寄存器：MAR、MDR、IR、暂存寄存器

## 2. 指令执行

指令周期：CPU 取出并执行一条指令的时间

- 一个指令周期由机器周期表示；不同的指令，指令周期可能不同
- 四种机器周期：取指周期、间址周期、执行周期、中断周期
  - 一个机器周期由时钟周期表示；不同的机器周期，时钟周期可能不同
  - 时钟周期由时钟信号确定，是 CPU 操作的基本单位
  - 中断周期：CPU 在每条指令执行结束前，查询中断响应可能的中断
  - 中断的栈朝着低地址增加
- CPU 使用 4 个标志触发器表示所在的机器周期：FE、IND、EX、INT
- 四个机器周期都可能进行访存：取指令、取有效地址、取操作数、保存程序断点

不同机器周期的数据流讨论：指令一次访问的数据序列（多个数据的数据流向？）

- 取指周期：PC、控制信号、指令内容、读信号
- 间址周期：有效地址、读信号、数据内容
- 执行周期：无统一的数据流
- 中断周期：堆栈指针、写信号、程序断点、中断程序入口地址

指令的执行方案：

- 单指令周期：所有指令选用相同执行时间完成，指令之间串行执行
  - 指令的执行时间取决于，执行时间最长的指令
- 多指令周期：不同类型的指令使用不同的执行时间完成，指令之间串行指令
- 流水线方案：指令之间并行执行，尽可能多条指令同时运行

## 3. 数据通路

数据通路：数据在功能部件之间传送的路径

- 需要控制部件根据具体的指令生成数据通路的控制信号
- 计算机的功能部件通过总线进行连接
  - 五大功能部件：控制器部件、运算器部件、输入设备、输出设备、内存
  - 三大总线：数据总线、地址总线、控制总线

数据交换的方法：

- 专用通路：不同的部件通过多路选择器或三态门直接和 ALU 相连
  - 性能较高实现复杂，只有在特定的场景下使用
- 内部总线：不同的部件通过总线和 ALU 进行数据交换，需要使用暂存寄存器进行缓冲
  - CPU 内部单总线结构：连接部件的总线只有一条
    - 一个时钟周期只能传送一个数据，存在较多的冲突，性能较低
  - CPU 内部三总线结构：数据总线、地址总线、控制总线？
    - 多个总线传送不同的数据，效率较高

功能部件之间的数据流动方式：

- 寄存器之间的数据流动
- 内存和 CPU 之间的数据流动
- 执行具体的数据运算

控制器的主要功能：取指、译指、生成控制信号

- 生成控制信号的两种方式：硬布线控制器、微程序控制器

### 3.1. 硬布线控制器

依靠组合逻辑门电路和触发器产生控制信号，也称组合逻辑控制器

- 主要特点：控制器的速度取决于电路延迟速度较快；但可维护性较差，难以通过额外修改直接添加功能
- 控制器的输入信号：译码的指令信息、时序信息、标志信息
  - 使用到的时序信息：机器周期信号、时钟信号
- 控制单元的产生的控制信号通过控制总线进行输出
- 控制单元主要处理的微操作种类：
  - 取指微操作、间址微操作、非访存指令微操作、转移指令微操作
  - 访存指令微操作：运算指令、存数指令微操作、取数指令微操作

CPU 的控制方式：执行不同微操作使用的时钟信号长度的控制方式

- 同步控制方式：系统使用统一的时钟，依据最长时间的微操作作为时钟信号
  - 所有的微操作拥有相同的时间间隔，控制电路简单，运行速度慢
- 异步控制方式：不存在基准时标信号，部件异步运行通过应答进行通讯
  - 运行速度块，控制电路复杂
- 联合控制方式：大部分微操作使用同步控制，小部分采用异步控制
  - 同步控制和异步控制的折中方法

硬布线控制单元的设计步骤：（数电中组合逻辑电路的设计方法）

1. 写出微操作命令的操作时间表
2. 进行综合归类整理（合并共用的元件，简化电路）
3. 得到微操作命令的逻辑电路图

### 3.2. 微程序控制器

微操作信号代码化：使用存储逻辑实现，将指令转换为一段微程序，注意和程序的区别

- 主要特点：规整灵活、可维护，但每次执行需要读取影响速度
- 每个微程序包含若干微指令，每个微指令包含若干微操作，一个微操作对应一个微命令
- 微操作构成控制序列的最小单位，最基本不可再分的操作
- 微程序也有对应的微地址寄存器 (CMAR) 和 微指令寄存器 (CMDR, $\mu$IR)

微指令：存储在控制存储器（CM），对应存储单元的地址为微地址

- 控制寄存器在 CPU 的内部，使用 ROM 实现
- 微命令之间的关系：相容性（可以同时发生的微命令），互斥性（不可以同时发生的微命令）
- 微指令包含的信息：
  - 操作控制字段，微操作码字段：用于产生所需的控制信号
  - 顺序控制字段，微地址码字段：用于控制下一条执行的微指令地址
- 微周期：读取并执行微指令所需的时间

微程序控制器的组成：

- 控制寄存器：存放各指令对应的微程序
- 微指令寄存器：存放当前指令对应的微程序微指令
- 微地址形成部件：产生初始微地址和后继微地址
- 微地址寄存器：存储微地址给控制寄存器用于读取微指令

微程序控制器的工作过程：

1. 执行取微指令公共操作（取指对应的微指令，可以统一编写为一个微程序）
2. 由机器指令的操作码字段确定微程序的入口地址
3. 从控制存储器中逐条取出微指令并执行，直至完成一条机器指令，继续循环

微指令的编码方式：

- 直接编码：每一位对应是否选择该微命令，并行执行对应的微操作
  - 简单直观速度快，并行执行；但微指令字长过长，需要控制存储器容量足够大
- 字段直接编码：将微指令分为若干字段，互斥的微命令放在同一字段，相容的微命令放在不同字段
  - 缩短微指令字长；但需要译码，速度比直接编码慢
  - 分段原则：每一个字段的信息位不能过多避免译码过于复杂；每一个字段需要保留一个状态，表示空命令
- 字段间接编码，隐式编码：一个字段需要另一个字段进行解释
  - 进一步缩短微指令字长，但削弱了并行控制能力，作为字段直接编码的辅助手段

微指令的地址形成方式：

- 断定方式：通过微指令的下地址字段指出
- 根据机器指令的操作码，通过微地址形成部件形成
- 增量计数法：适用于后继微指令地址连续的情况
- 通过标志决定微指令分支转移地址
- 通过网络测试形成
- 由硬件直接产生微程序入口指令

微指令的格式：

- 水平型微指令：一条指令定义执行多种并行基本操作
  - 微指令格式：操作控制 | 顺序控制
  - 直接编码、字段直接编码、字段间接编码和混合编码都属于水平型微指令
  - 微程序短、执行速度块，但微指令长、编写微程序麻烦，用户编程比较麻烦
- 垂直型微指令：一条执行定义执行一种基本操作
  - 微指令格式：微操作码 | 目的地址 | 源地址
  - 设置微操作码字段采用微操作码编译法
  - 指令短且规整，用户编程简单；但微程序长执行速度慢
- 混合型微指令：在垂直型微指令的基础上增加不复杂的并行操作
  - 兼具水平型微指令和垂直型微指令的优点

微程序控制单元的设计步骤：

1. 写出机器指令对应的微操作命令和节拍安排，和硬布线控制器的主要不同在于：
    - 要将指令的操作码送到微地址形成部件
    - 或将微指令的下地址字段送到 CMAR
2. 根据微操作的个数确定编码方式，微指令数确定顺序控制字段的位数
3. 根据操作控制字段的每一位代表的微操作命令，编写微指令码点

其它微程序设计：

- 动态微程序设计：通过 EPROM 实现用户可以依据要求修改微程序
- 毫微程序设计：通过二级控制存储器解释微程序来控制硬件

## 4. 指令流水线

增加少量硬件实现指令并行处理

- 指令的五级流水：取指、译码、取数、执行、写回
- 流水线的表示方式：时空图
  - 横坐标表示时间，每个指令的执行步骤进行分割
  - 纵坐标表示空间，流水线的每个流水段

实现指令流水线指令集应该具有的特征：

- 指令尽量规整一致，对齐存放，便于取指和译码
- 保证源寄存器的地址尽可能相同，方便进行预测提前操作
- 采用 `Load`/`Store` 指令，方便和其它指令统一执行步骤

流水线的特点：

- 将一个任务分解为多个子任务，依靠功能部件并行处理提高效率
- 流水线的每一个步骤后面增加一个缓冲寄存器，保存当前流水步骤的执行结果
- 流水线的每个步骤时间尽可能相等，否则隐去堵塞、断流
- 流水线用于连续任务，存在任务的装入时间和排空时间

流水线的分类：

- 流水线的级别：在计算不同级别中均可以设置流水线工作
  - 部件功能级：运算内部进行流水线分级，如：浮点数运算
  - 处理机级：指令之间的流水线分级
  - 处理机间流水：宏流水，不同的主机进行流水线写作工作
- 完成的功能：单功能流水线（只能完成一种功能）、多功能流水线（可以完成多种功能）
- 同一时间完成的工作：静态流水线（同一时间只能完成一种功能）、动态流水线（同一时间可以执行多种功能，必是多功能流水线？）
- 各个步骤之间是否存在反馈信号：线性流水线（不存在反馈回路）、非线性流水线（存在反馈回路，可能存在步骤多次经过流水线）

流水线的冲突：可能存在冲突导致流水线阻塞或停顿，存在三种冲突原因：

- 资源冲突：多条指令争夺使用同一硬件资源，如取数和取指均需访问存储器
  - 存在冲突可以使后一条指令延后访问硬件资源
  - 或设置多个硬件设备解决冲突，现实使用不同的 cache 解决冲突
- 数据冲突：后一条流水线需要使用前一条流水线的计算结果
  - 不同的数据冲突类型：**写后读**（真实情况按序流动只可能出现的冲突情况）、读后写、写后写（非按序流动才可能出现）
  - 解决方法：通过编译器调整指令顺序解决冲突
  - 设置硬件阻塞或者软件插入空操作 `NOP`，进行延后解决冲突
  - 数据旁路技术，设置专用的数据通路提前使用当前的计算结果无需暂停
- 控制冲突：指令之间控制相关
  - 由于指令跳转（条件、调用、中断）导致的断流
    - 中断的例子：cache 缺失导致流水线阻塞
  - 采用分支预测技术，提前生成转移的目标地址
    - 静态（简单）预测：预设一个静态的转移结果，通常是条件不满足
    - 动态预测：根据程序执行的历史情况进行预测，预测准确率较高
  - 提前取出执行两个方向上的指令
  - 加快或提前形成判断条件

流水线的性能指标：

- 吞吐率 (TP)：单位时间完成的任务数量
  - $TP = \frac{n}{(k+n-1)\Delta t}$
  - 当 $n \to \infty$ 时，$TP_{max} = 1 / \Delta t$
- 加速比 (S)：不使用流水线技术和使用流水线技术的时间之比
  - $S = \frac{kn}{k + n - 1}$
  - 当 $n \to \infty$ 时，$S_{max} = k$
- 流水线效率 (E)：流水线的设备利用率
  - 时空图中的有效面积比总面积
  - 当 $n \to \infty$ 时，$E_{max} = 1$

流水线的多发技术：

- 超标量流水线：每个时钟周期并发执行多条指令，需要配备多个功能部件（空分复用技术）
  - 通过编译优化技术将可并行执行的指令并行执行
- 超流水线技术：在一个机器周期中再分段，在同一个机器周期内一个功能部件使用多次（时分复用技术）
- 超长指令字：将多条可并行操作的指令组合成一条超长指令字
  - 包含多个操作码字段，可以使用多个处理部件提高执行效率
