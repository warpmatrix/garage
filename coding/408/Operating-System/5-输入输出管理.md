# IO 管理

不同的 IO 设备类别：

- 按使用特性分类：交互设备、存储设备、防落通信设备
- 按传输速率分类：低速（交互设备）、中速（打印机等）、高速设备（存储设备）
- 按信息交换的单位分类：
  - 块设备：以数据块为单位进行传输，有结构设备
    - 传输速率较高，可寻址（可以随机进行访问）
  - 字符设备：以字符为单位进行传输，无结构设备
    - 传输速率较低，不可寻址，通常使用中断驱动访问

IO 设备的控制方式：[机组中的 IO 方式](../Computer-Composition/7-输入输出.md)

- 程序控制（程序查询）、中断驱动、DMA 方式、通道控制方式
- 通道控制方式：增加负责 IO 的处理机，负责若干数据块的控制和管理
  - CPU 发出指令，IO 通道执行通道程序，控制多个设备和内存之间的数据传输（通道程序包含数据块大小、传输内存位置等）

## IO 子系统的层次结构

- 用户层：与用户交互的接口
- 设备独立性软件：实现用户程序和设备驱动的统一接口
  - 执行设备的公共操作、向用户层提供统一的接口
- 设备驱动程序：实现具体硬件的控制程序
- 中断处理程序：保存和恢复 CPU 的现场
- 硬件设备：设备控制器（适配器）、机械硬件
  - 设备控制器用于模块化（设备的插槽），具有两种编址方式：[机组中 IO 端口的编址方式](../Computer-Composition/7-输入输出.md)
  - 设备控制器的主要功能：接受命令发送状态、数据交换、识别设备地址
  - 设备控制器的组成：与 CPU 的接口、与设备的接口、IO 控制逻辑

## IO 核心子系统

多种方法协调不同 IO 设备之间的差异：IO 调度、高速缓存与缓冲、设备分配与回收、假脱机、设备保护、差错处理

IO 调度：使进程公平共享设备访问，减少 IO 完成所需的等待时间

- 每一个设备维护一个请求队列实现调度，例子：磁盘的调度方法

磁盘高速缓存：使用内存暂存磁盘中的信息，提高访问速度

- 逻辑属于磁盘，物理上驻留在内存中的盘块
- 两种实现形式：内存开辟新的存储空间（大小固定）、使用未利用的内存空间作为缓冲持，供分页系统和磁盘 IO 共享

缓冲区：低速设备的数据写入缓冲区，高速设备每次可以高速读写大量数据

- 缓冲区空才能写入直至写满；缓冲区满才能读出直至读空
- 缓解设备之间速度不匹配的问题，解决数据单元不同的问题
- 减少中断频率，提高 CPU 和 IO 设备之间的并行性
- 实现方法：使用硬件缓冲器（成本较高，仅在关键部位使用）、使用内存的缓冲区
- 根据缓冲器数量划分不同的缓冲技术：
  - 单缓冲：在设备和处理机之间设置一个缓冲区
    - 每块数据的处理时间：$\max(C, T) + M$
    - 两个设备之间每个时刻只能实现单向的数据传输
  - 双缓冲：设置两个缓冲器，提高 CPU 和设备在缓冲区传入用户区时间的利用率
    - 每块数据的处理时间：$\max(C + M, T)$
    - 对于字符设备采用行输入，则当前输入的执行和下一输入可以并行进行
    - 双缓冲可以实现同时的双向数据传输
  - 循环缓冲：包含多个大小相等的缓冲区构成一个环形
    - 使用指针识别输出和输入的缓冲区（循环队列）
  - 缓冲池：多个系统公用的缓冲区组成
    - 四种缓冲区：收容输入数据的缓冲区、提取输入数据的缓冲区、收容输出数据的缓冲区、提取输出数据的缓冲区
    - 三种缓冲区队列：空缓冲区队列、输入队列、输出队列
  - 设 $C$ 为 CPU 对数据的处理帅缠绵，$M$ 为缓冲区数据传入用户区的时间，$T$ 为设备数据写入缓冲区的时间

设备的分配：根据用户请求分配设备，发挥设备的使用效率，同时避免死锁

- 三种类型的设备：独占式使用设备、分时式共享使用设备、SPOOLing 使用设备
- 设备分配涉及的数据结构：分配设备需要设备、控制器、通道均空闲
  - 设备控制表 (DCT)：记录一个设备的各个属性（类型、标识符、状态等）
  - 控制器控制表 (COCT)：记录设备对应控制器的各个属性（标识符、状态、对应通道的通道控制表的指针）
  - 通道控制表 (CHCT)：记录通道的各个属性（标识符、状态、与通道连接的控制器表的指针）
    - 一个通道可为多个设备控制器服务，CHCT 和 COCT 是一对多的关系
  - 系统设备表 (SDT)：记录系统的所有物理设备情况，每个设备占用一个表项
- 分配涉及因素：设备属性、分配算法、安全性、独立性
- 分配方式：
  - 静态分配：一次性分配所有的资源
    - 适用于独占设备，不会出现死锁，但使用效率低
  - 动态分配：执行时提出设备请求，使用完毕释放
    - 每个传输时刻只被一个进程占有
    - 提高设备的利用率，但可能造成死锁
- 分配算法：先请求先分配、优先级分配
- 分配的安全性：防止进程发生死锁
  - 安全分配：进程发出请求后进入阻塞态，直到完成 IO 操作被唤醒
    - 分配安全，但在一个进程中 CPU 和 IO 设备串行工作
  - 不安全分配：进程发出 IO 请求后继续运行，只有设备被占用才进入阻塞态
    - 可以迅速推动进程，但可能产生死锁
- 提高分配的成功率：多个设备（设备的独立性）、多个通路

逻辑设备和物理设备的映射：应用程序使用逻辑设备名来请求设备

- 应用程序独立于具体的物理设备，提高灵活性和设备的利用率
- 逻辑设备表 (LUT) 完成逻辑设备到物理设备之间的映射
  - 表项包含逻辑设备名、物理设备名、驱动程序入口地址
- 逻辑设备表的两种建立方式：整个系统设置一张 LUT、每个用户设置一张 LUT（存储在用户初始进程的 PCB 中）
- 设备独立性的作用：方便用户编程、使程序便于移植，不受具体的环境影响

假脱机技术 (SPOOLing)：外部设备同时联机操作

- 将独占设备锁使用的数据暂存在磁盘中，以空间换时间提高 CPU 的速度
- 使用专门的外围控制及将低速设备的数据传送到磁盘上
  - 使用磁盘中的输入/输出井作为输入/输出缓冲区和内存之间的媒介
- 可以将独占设备改造为共享设备：
  - 每一个进程使用设备在输入/输出井中申请磁盘块区
  - 再将用户请求表加入请求队列中
