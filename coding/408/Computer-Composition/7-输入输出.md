# IO 系统

输入/输出以主机为中心，IO 系统主要解决各种形式的信息进行 IO 的控制

- 外部设备：相对于计算机的外部设备（输入/输出设备、外部存储设备）
- 接口：传输数据进行协调的逻辑部件（速度匹配、格式转换、电平转换）

IO 系统由 IO 软件和 IO 硬件组成：

- IO 软件：驱动、管理程序、补丁、用户程序
  - 使用 IO 指令和通道指令实现信息交换
- IO 硬件：外部设备、控制器、接口、IO 总线
  - 通过设备控制器控制具体的设备操作

IO 控制方式：

- 查询：CPU 不断查询 IO 设备的信息，适用于传输速度较慢的设备
- 中断：IO 设备向 CPU 发出中断请求，适用于传输速度较慢的设备
- DMA：内存和 IO 设备之间有直接数据通路，无需调用中断服务，适用于传输速度较快的设备
- 通道：通道执行通道程序完成 IO 操作，适用于传输速度较快的设备

## 常见 IO 设备

键盘：输入设备，查询按键、译码（-> ASCII）、发送编码

鼠标：定位输入设备，传感器检测、控制光标移动

显示器：

- 显示器件分类：
  - CRT（阴极射线管显示器）：电子枪射击荧光粉
    - 角度大、无坏点、色彩还原度高、多分辨率、响应时间短
    - 不同的扫描方式：光栅扫描、随机扫描
  - LCD（液晶显示器）：液晶的电光效应
    - 体积小、能耗低、环保不伤眼
  - LED（发光二极管显示器）：控制发光二极管显示
    - 高亮度、低功耗、可视角度大、刷新速率高
- 显示内容分类：字符显示器、图形显示器、图像显示器
  - 字符显示器：以点阵为基础显示字符，点阵存入 ROM
    - 每一个字符对应一个字符窗口，包括：字符点阵和字符间隔
  - 图形显示器：依靠坐标点和绘图命令显示矢量
    - 使用模拟电压控制电子束，产生稳定的图像
- 主要参数：屏幕大小（对角线长度）、分辨率、灰度级、刷新频率、显示存储器 (VRAM)
  - 刷新：光点消失之前重新扫描
  - VRAM 的容量：分辨率 $\times$ 灰度级
  - VRAM 的带宽：容量 $\times$ 帧数

打印机：

- 按工作原理分类：打击式、非打击式
- 按工作方式：点阵打印机、针式打印机、喷墨打印机、激光打印机

外存储器（辅助存储器）：盘面、柱面、扇区，通过电磁转换完成读写操作

- 组成：磁盘驱动器（磁头组件、盘片组件）、磁盘控制器（磁盘和主机的接口）
- 性能指标：
  - 容量：非格式化容量（总容量）、格式化容量（磁盘经过格式化后的有效容量）
  - 记录密度：盘片单位面积的二进制信息量
    - 道密度（半径方向单位长度的刺刀数量）、位密度（磁道单位长度的二进制位数）
  - 平均存取时间：寻道时间、旋转延迟、传输时间
    - 主要有寻道时间和旋转延迟决定，时间不定通常使用平均值表示
  - 数据传输速率：$D_r = rN$，转速乘磁道容量
- 磁盘地址 = 驱动器号 | 柱面号 | 盘面号 | 扇区号
- 硬盘的工作过程：寻址、读盘、写盘
  - 读写过程串行操作，和主机交换数据需要引入串并转换器

廉价冗余磁盘阵列 (RAID)：

- RAID0：交叉存储，可以并行读写，但没有冗余和容错性
- RAID1：使用镜像磁盘，牺牲一半的存储空间换取冗余和容错能力
- RAID2-RAID5：引入海明码作为容错机制

固态硬盘：使用闪存作为存储介质

## IO 接口

主机和外设之间的交接，实现功能：

- 主机和外设的通讯控制、进行地址译码设备选择、数据缓冲格式转换、控制命令和状态信息的传送等功能
  - 数据缓冲：消除设备之间的速度不匹配
  - 信号格式转换：电平转换、串并转换、数模转换

IO 接口的主要结构：

- 主机侧：和系统总线相连，数据线、地址线、控制线
- 数据缓冲寄存器、状态寄存器、控制寄存器通过数据线进行数据交换
  - 状态寄存器（只可读）和控制寄存器（只可写）在数据传输方向上相反
  - 地址线和控制线和控制逻辑相连，实现地址译码等功能
  - 控制线传输读写信号、仲裁信号、握手信号等
  - IO 指令：访问 IO 接口的寄存器访问需要使用，是一种特权指令

IO 接口的分类：

- 按数据传送方式分类：并行接口（一个字的所有位同时进行传送）、串行接口（逐位进行传送）
  - 主机和接口一侧总是并行传输，可能使用到串并转换器
- 按主机访问方式分类：查询接口、中断接口、DMA 接口
- 按功能的灵活性分类：可编程接口、不可编程接口

IO 端口：可以被 CPU 直接访问的寄存器（数据端口、状态端口、控制端口）。

IO 端口的编址方式如下：

- 统一编址，存储器映射方式：将 IO 端口作为存储器单元进行地址分配
  - 不需要设置专门的 IO 指令，用统一访存指令可以进行访问
  - 操作更加灵活方便，并且端口又较大的编址空间
  - 但使内存的容量减小，并且通过存储器编址执行速度较慢
- 独立编址，IO 映射方式：IO 端口的地址空间和内存的地址空间作为两个独立的地址空间
  - 需要专门设置 IO 指令访问 IO 端口
  - 程序更加清晰便于理解，但需要准备两组指令和控制信号

## IO 方式

程序查询：由主机执行程序实现信息交换控制

- 设置数据端口和状态端口，通过计数器判断是否传输结束
- 先发出询问信号读取状态，再决定下一步的行为
- 设计简单，设备量少，但 CPU 和 IO 串行工作，需要花费时间查询和等待

程序中断：外设接口使用中断请求和控制逻辑结合中断硬件线路和中断服务程序完成，传输数据的基本单位是字

- CPU 每个指令执行周期后，响应中断请求
- CPU 暂时中止程序，转去处理异常情况；处理完毕后，返回继续执行程序
- 实现 CPU 和 CPU 之间或和 IO 的并行工作，依据中断实现快速响应
- 用户可以发送外部信号，方便人机进行交互
- 可以实现多道程序、分时、管态程序切换等功能

DMA 方式：硬件进行成组信息传送的控制，传输数据的基本单位是数据块

- CPU 每个机器周期结束后（总线不被占用），响应 DMA 请求
- 仅在开始传输和结束传输才需要 CPU 干预
- 响应优先级高于中断请求，但仅用于数据传送
- DMA 在外设和内存之间形成直接数据通道，不需要经过 CPU
- CPU 和外设的并行工作，无需保存现场恢复现场等操作
- 硬件开销较大，适合大批量数据传送

### 中断和异常

异常：CPU 内部引起的意外事件，需要 CPU 检测

- 如：缺页异常、运算错误等
- 异常引起的方式：硬故障中断和程序性异常（软中断）
- 异常的报告方式和返回方式：
  - 故障：指令执行结束前，被检测到异常
    - 处理故障后继续当前指令的执行，或终止进程的执行
  - 自陷（陷阱、陷入）：预先安排的异常事件
    - 执行自陷指令后，根据陷阱类型进行处理，然后返回下一条指令
    - 80x86 通过自陷的方式实现调试
  - 终止：计算机发生硬件故障，无法继续执行
    - 终止程序，调出中断服务程序重启系统
  
中断（外部中断）：CPU 外部和指令执行无关的事件引起的中断

- 如：IO 中断、外部信号中断、定时器中断
- CPU 需要通过总线获得中断源的标识信息，需要外部信号通知 CPU
- 中断响应条件：有中断请求、CPU 允许中断（开中断）、当前指令执行完毕且当前中断优先级最高

中断：异常和外部中断的统称

- 中断源、中断触发器 (INTR)
- 是否会被响应：不可屏蔽中断（关中断可以不被响应）、可屏蔽中断（任何时候都要响应）
  - 异常（内中断）均为不可屏蔽中断，NMI 发出的中断位不可屏蔽中断
- 中断是否可以嵌套：
  - 单重中断：处理中断过程中不响应优先级更高的中断
  - 多重中断（中断嵌套）：允许嵌套，需要使用到中断屏蔽技术
- 中断向量：每一个中断类型对应的中断服务程序的入口地址
- 中断向量表：中断向量集中存储的区域

中断判优：中断响应的优先级，硬软均可实现（排队器、查询程序）

- 硬件故障中断 > 软件中断，不可屏蔽中断 > 可屏蔽中断，DMA 请求 > IO 设备请求
- 高速设备请求 > 低速设备请求，输入设备 > 输出设备，实施设备 > 普通设备

中断隐指令：响应中断转去中断服务程序的操作

- 关中断、保存断点、转至中断服务程序

中断处理的步骤：

1. **关中断**、保存断点、转到中断处理程序
1. 保存现场、**开中断**、执行中断服务程序
1. **关中断**、回复现场和屏蔽字、**开中断**、中断返回

### DMA 方式

由硬件电路实现地址确定、传送数据计数等功能，需要开辟新的缓冲区

- 开始传送前需要程序进行**预处理**，结束后通过中断进行**后处理**

DMA 控制器（DMA 接口）：对传送过程进行控制，具有控制总线的能力

- 接受外设的 DMA 请求，向 CPU 发出总线请求，响应后接管系统总线
- 确定内存地址和传送长度，发出对应控制信号进行传送。结束后向 CPU 报告 DMA 操作结束
- 组成：主存地址计数器（内存地址寄存器，MAR）、传送长度计数器（数据计数器，DC）、数据缓冲寄存器（数据寄存器，DR）、DMA 请求触发器、中断机构、控制/状态逻辑（命令/状态寄存器，CR）

DMA 和 CPU 使用主存的方式：

- 停止 CPU 访存：直到数据传送完毕，才将总线控制权还给 CPU
- 周期挪用（周期窃取）：CPU 正在访存则 CPU 继续，否则 IO 优先挪用一两个存取周期或直接传输
  - 单字传送方式：传输传送单字数据即可释放总线，避免因为 IO 不立即访存导致丢失数据
- 交替访存：总线分时控制，适用于 CPU 工作周期比内存存取周期长

DMA 的传送过程：

1. 预处理：测试 IO 设备状态，初始化 DMA 控制器，等待 DMA 发出请求
2. 数据传送：以字、字节或块为基本单位进行传送，DMA 控制器实现循环功能
3. 后处理：DMA 向 CPU 发出中断信号，CPU 校验数据、决定 DMA 下一步操作等
